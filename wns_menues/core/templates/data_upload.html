<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carga de Datos - Menús WNS</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500&display=swap" rel="stylesheet">
    
    <style>
        body, html {
            margin: 0;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: #FFFFFF;
            color: #333333;
            padding: 4rem 0;
        }

        .reception-container {
            text-align: center;
            padding: 3rem;
            max-width: 900px;
            margin: auto;
        }

        .reception-container h1 {
            margin-bottom: 1rem;
            font-weight: 300;
            font-size: 3rem;
        }

        .options-divider {
            margin-top: 3rem;
            padding-top: 3rem;
            border-top: 1px solid #EEE;
            width: 100%;
        }

        .options-divider:first-of-type {
            margin-top: 0;
            padding-top: 0;
            border-top: none;
        }

        .options-divider h2 {
            font-size: 1.2rem;
            font-weight: 500;
            color: #AAA;
            margin-bottom: 2rem;
        }


        .btn-custom {
            padding: 1rem 1.5rem;
            font-size: 1.1rem;
            font-weight: 500;
            border-radius: 50px;
            min-width: 350px;
            margin: 0.5rem;
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
        }
        
        /* Color Principal */
        .btn-primary-custom {
            background-color: #A9C1A0;
            color: #FFFFFF;
            border: 2px solid #A9C1A0;
        }
        .btn-primary-custom:hover {
            background-color: #97ae8d;
            border-color: #97ae8d;
            color: #FFFFFF;
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* Color Secundario */
        .btn-secondary-custom {
            background-color: transparent;
            color: #888888;
            border: 2px solid #DDDDDD;
        }
        .btn-secondary-custom:hover {
            background-color: #f7f7f7;
            border-color: #CCCCCC;
            color: #555555;
        }

        .btn-grey-custom {
            background-color: #E0E0E0;
            color: #333333;
            border: 2px solid #E0E0E0;
        }

        .btn-grey-custom:hover {
            background-color: #d0d0d0;
            border-color: #d0d0d0;
            color: #333333;
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .back-link {
            text-decoration: none;
            color: #888888;
            font-weight: 500;
            transition: color 0.3s ease;
            position: absolute;
            top: 2.5rem;
            left: 2.5rem;
        }

        .back-link:hover {
            color: #333333;
        }

        /* Colores Opción 3 */
        .btn-carnes-custom {
            background-color: #D4BBA2;
            color: #FFFFFF;
            border: 2px solid #D4BBA2;
        }
        .btn-carnes-custom:hover {
            background-color: #c8ab8f;
            border-color: #c8ab8f;
            color: #FFFFFF;
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .btn-verduras-custom {
            background-color: #F1C2A3;
            color: #FFFFFF;
            border: 2px solid #F1C2A3;
        }
        .btn-verduras-custom:hover {
            background-color: #e8b38f;
            border-color: #e8b38f;
            color: #FFFFFF;
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .modal-header {
            border-bottom: none;
        }
        .modal-footer {
            border-top: none;
        }

        /* Para que el alert aparezca sobre el modal semi-transparente */
        .alert-container {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1060; /* Mayor que el z-index del modal (1055) */
            min-width: 300px;
        }
    </style>
</head>
<body>
    <div id="alert-container"></div>
    
    <div class="reception-container">
        <h1>Carga de Datos</h1>
        

        <!-- Opción 1: Vínculo Superior -->
        <div class="">

            <a href="{% url 'home' %}" class="back-link d-none d-md-block">&larr; Volver al Menú</a>
            <div>
                <a href="#" class="btn btn-custom btn-primary-custom" data-bs-toggle="modal" data-bs-target="#uploadModal" data-modal-title="Cargar Recetas (.md)" data-file-type=".md" data-upload-url="{% url 'api:upload_recipes' %}">Cargar Recetas</a>
            </div>
            <div>
                <a href="#" class="btn btn-custom btn-secondary-custom" data-bs-toggle="modal" data-bs-target="#uploadModal" data-modal-title="Cargar Precios Carnes (.xls, .xlsx)" data-file-type=".xls,.xlsx" data-upload-url="{% url 'api:upload_meats' %}">Cargar Precios Carnes</a>
            </div>
            <div>
                <a href="#" class="btn btn-custom btn-secondary-custom" data-bs-toggle="modal" data-bs-target="#uploadModal" data-modal-title="Cargar Precios Verduras (.pdf)" data-file-type=".pdf" data-upload-url="{% url 'api:upload_vegetables' %}">Cargar Precios Verduras</a>
            </div>
        </div>


    </div>

    <!-- Modal -->
    <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 1rem;">
          <div class="modal-header">
            <h5 class="modal-title" id="uploadModalLabel">Cargar Archivo</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Seleccione el archivo que desea cargar. Solo se aceptan los formatos permitidos.</p>
            <input class="form-control" type="file" id="fileInput">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary-custom" style="min-width: 150px;" id="uploadBtn">
                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                <span class="button-text">Subir Archivo</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const uploadModal = document.getElementById('uploadModal');
        const uploadBtn = document.getElementById('uploadBtn');
        const fileInput = document.getElementById('fileInput');
        const bsUploadModal = new bootstrap.Modal(uploadModal);

        // Función para mostrar alertas dinámicas
        const alertContainer = document.getElementById('alert-container');
        const showAlert = (message, type = 'success') => {
            div_to_erase = alertContainer.querySelector('.alert-dismissible');
            if (div_to_erase) {
                div_to_erase.remove();
            }
            const wrapper = document.createElement('div');
            wrapper.innerHTML = [
                `<div class="alert alert-${type} alert-dismissible fade show" role="alert">`,
                `   <div>${message}</div>`,
                '   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>',
                '</div>'
            ].join('');

            alertContainer.append(wrapper);

        };

        // Configurar modal al abrirse
        uploadModal.addEventListener('show.bs.modal', function (event) {
          const button = event.relatedTarget;
          
          const modalTitle = button.getAttribute('data-modal-title');
          const fileType = button.getAttribute('data-file-type');
          const uploadUrl = button.getAttribute('data-upload-url');
          
          const modalTitleElement = uploadModal.querySelector('.modal-title');
          
          modalTitleElement.textContent = modalTitle;
          fileInput.accept = fileType;
          fileInput.value = '';

          // Guardamos la URL en el dataset del botón de subida para usarla después
          uploadBtn.dataset.uploadUrl = uploadUrl;
        });

        // Lógica de subida de archivo
        uploadBtn.addEventListener('click', async () => {
            const file = fileInput.files[0];
            const uploadUrl = uploadBtn.dataset.uploadUrl;

            if (!file) {
                showAlert('Por favor, seleccione un archivo.', 'warning');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            const buttonText = uploadBtn.querySelector('.button-text');
            const spinner = uploadBtn.querySelector('.spinner-border');

            // Mostrar estado de carga
            buttonText.textContent = 'Subiendo...';
            spinner.classList.remove('d-none');
            uploadBtn.disabled = true;

            try {
                const response = await fetch(uploadUrl, {
                    method: 'POST',
                    headers: {
                        // Django CSRF token
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: formData,
                });

                const result = await response.json();

                if (response.ok) {
                    // --- MANEJO DE ÉXITO (200 OK) ---
                    
                    // Verificamos si el backend reportó errores parciales (Warning)
                    if (result.data && result.data.errors && result.data.errors.length > 0) {
                        
                        // Construimos una lista HTML con los errores
                        let errorHtml = `<strong>${result.message}</strong><hr class="my-2">`;
                        errorHtml += `<small>Detalles:</small><ul class="mb-0 ps-3 mt-1">`;
                        
                        result.data.errors.forEach(err => {
                            errorHtml += `<li>${err}</li>`;
                        });
                        errorHtml += `</ul>`;

                        // Mostramos alerta AMARILLA y NO se cierra sola (autoDismiss=false)
                        showAlert(errorHtml, 'warning', false);
                        
                    } else {
                        // Éxito Total (Verde)
                        showAlert(result.message || 'Operación exitosa', 'success', true);
                    }

                } else {
                    // --- MANEJO DE ERROR HTTP (400, 500) ---
                    
                    let errorMessage = result.message || 'Error al subir el archivo.';
                    
                    // Si el error viene del Serializer (ej: extensión inválida) suele venir en result.file
                    if (result.file) {
                        errorMessage = Array.isArray(result.file) ? result.file.join(' ') : result.file;
                    }
                    // Si viene del Serializer general (ej: non_field_errors)
                    else if (result.non_field_errors) {
                         errorMessage = result.non_field_errors.join(' ');
                    }

                    showAlert(errorMessage, 'danger', false);
                }

            } catch (error) {
                console.error('Error en la subida:', error);
                showAlert('Ocurrió un error de red. Inténtelo de nuevo.', 'danger');
            } finally {
                // Restaurar botón
                buttonText.textContent = 'Subir Archivo';
                spinner.classList.add('d-none');
                uploadBtn.disabled = false;
                bsUploadModal.hide();
            }
        });
    </script>
</body>
</html>
